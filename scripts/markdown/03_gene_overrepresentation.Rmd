---
title: "Impact of dysfunctional ubiquitination in response to cancer immunotherapy"
subtitle: <center> Somatic mutations analysis - Gene Overrepresentation Analysis </center>
author: "Eric Bautista Farrerons (s212514)"
date: '`r paste("First created on January 2024. Updated on ", format(Sys.Date(), "%d %B %Y"))`'
output:
  html_document:
    css: style.css
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 4
    number_sections: true
---

# Load data

```{r, message=FALSE}
### Load required libraries
library(readxl)
library(tidyverse)
library(purrr)
library(dplyr)
library(knitr)
library(DT)
library(httr)
library(jsonlite)
library(stringr)

### Load functions
source(file = "../02_functions.R")

### Define paths
current_dir <- getwd()
results_pc_path <- file.path(current_dir,
                              "../../results/output/patient_characteristics")
results_fip_path <- file.path(current_dir,
                              "../../results/output/somatic_mutation_analysis/functional_impact_prediction")
results_gor_path <- file.path(current_dir, 
                                 "../../results/output/somatic_mutation_analysis/gene_overrepresentation_analysis")
figures_path <- file.path(current_dir, 
                                 "../../results/figures")

maf_df_path <- file.path(results_fip_path, "all_mutations.csv") # All mutations df
nonsyn_df_path <- file.path(results_fip_path, "nonsyn_mutations.csv") # Nonsyn mutations df
lof_df_path <- file.path(results_fip_path, "lof_mutations.csv") # LoF mutations df

# Sup1 data
sup1_response_path <- file.path(results_pc_path, 
                           "sup1_response.csv")
### Read data & wrangle

# Read 3 lists of mutations

# All
maf_df_annotated <- read.csv(maf_df_path, header = TRUE)[ , -1]
list_of_all_mutations <- split(maf_df_annotated, maf_df_annotated$sample_id
                               )
# Nonsyn
nonsyn_df_annotated <- read.csv(nonsyn_df_path, header = TRUE)[ , -1]
list_of_nonsyn_mutations <- split(nonsyn_df_annotated, nonsyn_df_annotated$sample_id)

# LoF
lof_df_annotated <- read.csv(lof_df_path, header = TRUE)[ , -1]
list_of_lof_mutations <- split(lof_df_annotated, lof_df_annotated$sample_id)

# Get the list of patient IDs
sample_id_list <- unique(maf_df_annotated$sample_id)

## Read sup1_response.csv
sup1_response_df <- read.csv(sup1_response_path)[ , -1] # Drop first column

# df to merge response info later
response_df <- sup1_response_df %>% 
  dplyr::rename(sample_id = Sample.ID,
                patient_response = Patient.Response) %>% 
  dplyr::select(sample_id, patient_response)

# Create a list of Responders and Non-responders
sample_id_lists <- split(sup1_response_df$Sample.ID, 
                         sup1_response_df$Patient.Response) # Split the "Sample.ID" values into lists based on "Patient.Response"

r_sample_ids <- sample_id_lists$R
nr_sample_ids <- sample_id_lists$NR
```

# Pathway analysis (gene overrepresentation)

## First analysis using C5 - BP

```{r, message=FALSE, warning=FALSE}
# Define paths
fora_results_all_csv_path <- file.path(results_gor_path, "fora_results_c5bp_all.csv")
fora_results_nosnyn_csv_path <- file.path(results_gor_path, "fora_results_c5bp_nonsyn.csv")
fora_results_lof_csv_path <- file.path(results_gor_path, "fora_results_c5bp_lof.csv")

# Perform FORA analysis for H Gene Sets
results_list <- perform_fora_analysis("C5", "BP", list_of_all_mutations, list_of_nonsyn_mutations, list_of_lof_mutations, fora_results_all_csv_path, fora_results_nosnyn_csv_path, fora_results_lof_csv_path)

# Unpack the results_list
fora_results_c5bp_all_list <- results_list$fora_results_all_list
fora_results_c5bp_nonsyn_list <- results_list$fora_results_nonsyn_list
fora_results_c5bp_lof_list <- results_list$fora_results_lof_list
```

### Visualization: Example with Immune-related bioprocesses of MM909_03 (LoF)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_03_immune_bp_plot_path <- file.path(figures_path,
                              "mm909_03_immune_bp_plot.png")

# Filter the data
top_immune_bp <- fora_results_lof_list$MM909_03 %>%
  dplyr::filter(pathway %in% c("GOBP_REGULATION_OF_IMMUNE_SYSTEM_PROCESS",
                               "GOBP_IMMUNE_RESPONSE",
                               "GOBP_POSITIVE_REGULATION_OF_IMMUNE_SYSTEM_PROCESS",
                               "GOBP_REGULATION_OF_IMMUNE_RESPONSE",
                               "GOBP_INNATE_IMMUNE_RESPONSE")
                ) %>% 
  dplyr::mutate(Gene_ratio = overlap / size) %>% 
  dplyr::rename(Count = overlap) %>% 
  dplyr::arrange(desc(Gene_ratio))

# Create a bar plot
top_immune_bp_plot <- ggplot(top_immune_bp, aes(x = Gene_ratio, 
                                                y = reorder(pathway,
                                                            Gene_ratio),
                                                size = Count,
                                                color = padj)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", colour = "black"), # Set background to white with grey border
    panel.grid.major = element_line(color = "grey", linewidth = 0.5),  # Adjust major gridlines
    panel.grid.minor = element_blank(),  # Hide minor gridlines for a cleaner look
    plot.background = element_rect(fill = "white", colour = NA),  # Set plot background to white
    legend.position = "right"
  ) +
  labs(title = "ORA example with immune BP of MM909_03",
       x = "Gene Ratio", 
       y = "Bio Process",
       color = "p.adjust",
       size = "Count") +
  guides(color = guide_colorbar(title = "p.adjust"), 
         size = guide_legend(title = "Count"))

# Print plot
print(top_immune_bp_plot)

# Save plot
ggsave(mm909_03_immune_bp_plot_path, top_immune_bp_plot, width = 10, height = 8, dpi = 300)
```

### Visualization: Top C5 BP across samples stratified by response (All mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c5bp_all_plot_path <- file.path(figures_path,
                              "mm909_c5bp_all_plot.png")

mm909_c5bp_all_plot <- plot_top5(response_df, fora_results_c5bp_all_list, mm909_c5bp_all_plot_path, "FORA with top C5 BP across samples (All mutations)", "Top C5 BP Gene Sets")

print(mm909_c5bp_all_plot)
```

### Visualization: Top C5 BP across samples stratified by response (Nonsyn mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c5bp_nonsyn_plot_path <- file.path(figures_path,
                              "mm909_c5bp_nonsyn_plot.png")

mm909_c5bp_nonsyn_plot <- plot_top5(response_df, fora_results_c5bp_nonsyn_list, mm909_c5bp_nonsyn_plot_path, "FORA with top C5 BP across samples (Nonsyn mutations)", "Top C5 BP Gene Sets")

print(mm909_c5bp_nonsyn_plot)
```

### Visualization: Top C5 BP across samples stratified by response (LoF mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c5bp_lof_plot_path <- file.path(figures_path,
                              "mm909_c5bp_lof_plot.png")

mm909_c5bp_lof_plot <- plot_top5(response_df, fora_results_c5bp_lof_list, mm909_c5bp_lof_plot_path, "FORA with top C5 BP across samples (LoF mutations)", "Top C5 BP Gene Sets")

print(mm909_c5bp_lof_plot)
```

## Second analysis using C5 - CC

```{r, message=FALSE, warning=FALSE}
# Define paths
fora_results_all_csv_path <- file.path(results_gor_path, "fora_results_c5cc_all.csv")
fora_results_nosnyn_csv_path <- file.path(results_gor_path, "fora_results_c5cc_nonsyn.csv")
fora_results_lof_csv_path <- file.path(results_gor_path, "fora_results_c5cc_lof.csv")

# Perform FORA analysis for H Gene Sets
results_list <- perform_fora_analysis("C5", "CC", list_of_all_mutations, list_of_nonsyn_mutations, list_of_lof_mutations, fora_results_all_csv_path, fora_results_nosnyn_csv_path, fora_results_lof_csv_path)

# Unpack the results_list
fora_results_c5cc_all_list <- results_list$fora_results_all_list
fora_results_c5cc_nonsyn_list <- results_list$fora_results_nonsyn_list
fora_results_c5cc_lof_list <- results_list$fora_results_lof_list
```

### Visualization: C5 CC PROTEASOME across samples stratified by response (LoF mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c5cc_proteasome_lof_plot_path <- file.path(figures_path,
                              "mm909_c5cc_proteasome_lof_plot.png")

proteasome_genesets = c("GOCC_PROTEASOME_ACCESSORY_COMPLEX", "GOCC_PROTEASOME_COMPLEX", "GOCC_PROTEASOME_CORE_COMPLEX", "GOCC_PROTEASOME_CORE_COMPLEX_ALPHA_SUBUNIT_COMPLEX", "GOCC_PROTEASOME_CORE_COMPLEX_BETA_SUBUNIT_COMPLEX", "GOCC_PROTEASOME_REGULATORY_PARTICLE", "GOCC_PROTEASOME_REGULATORY_PARTICLE_BASE_SUBCOMPLEX", "GOCC_PROTEASOME_REGULATORY_PARTICLE_LID_SUBCOMPLEX")

mm909_c5cc_proteasome_lof_plot <- plot_geneset(proteasome_genesets, response_df, fora_results_c5cc_lof_list, mm909_c5cc_proteasome_lof_plot_path, "FORA with PROTEASOME-related C5 CC Gene Sets across samples (LoF mutations)", "PROTEASOME Gene Sets")

print(mm909_c5cc_proteasome_lof_plot)
```

## Third analysis using H

```{r, message=FALSE, warning=FALSE}
# Explore what H Gene Sets exist for Human
all_gene_sets <- msigdbr(species = "Homo sapiens")
all_gene_sets %>%
  dplyr::filter(gs_cat == "H")
```

```{r, message=FALSE, warning=FALSE}
# Define paths
fora_results_all_csv_path <- file.path(results_gor_path, "fora_results_h_all.csv")
fora_results_nosnyn_csv_path <- file.path(results_gor_path, "fora_results_h_nonsyn.csv")
fora_results_lof_csv_path <- file.path(results_gor_path, "fora_results_h_lof.csv")

# Perform FORA analysis for H Gene Sets
results_list <- perform_fora_analysis("H", NULL, list_of_all_mutations, list_of_nonsyn_mutations, list_of_lof_mutations, fora_results_all_csv_path, fora_results_nosnyn_csv_path, fora_results_lof_csv_path)

# Unpack the results_list
fora_results_h_all_list <- results_list$fora_results_all_list
fora_results_h_nonsyn_list <- results_list$fora_results_nonsyn_list
fora_results_h_lof_list <- results_list$fora_results_lof_list
```

### Visualization: Top H across samples stratified by response (All mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_h_all_plot_path <- file.path(figures_path,
                              "mm909_all_h_plot.png")

mm909_h_all_plot <- plot_top5(response_df, fora_results_h_all_list, mm909_h_all_plot_path, "FORA with top H across samples (All mutations)", "Top H Gene Sets")

print(mm909_h_all_plot)
```

### Visualization: Top H across samples stratified by response (Nonsyn mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_h_nonsyn_plot_path <- file.path(figures_path,
                              "mm909_nonsyn_h_plot.png")

mm909_h_nonsyn_plot <- plot_top5(response_df, fora_results_h_nonsyn_list, mm909_h_nonsyn_plot_path, "FORA with top H across samples (Nonsyn mutations)", "Top H Gene Sets")

print(mm909_h_nonsyn_plot)
```

### Visualization: Top H across samples stratified by response (LoF mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_h_lof_plot_path <- file.path(figures_path,
                              "mm909_lof_h_plot.png")

mm909_h_lof_plot <- plot_top5(response_df, fora_results_h_lof_list, mm909_h_lof_plot_path, "FORA with top H across samples (LoF mutations)", "Top H Gene Sets")

print(mm909_h_lof_plot)
```

### Visualization: HALLMARK_APOPTOSIS across samples stratified by response (LoF)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_h_apoptosis_plot_path <- file.path(figures_path,
                              "mm909_h_apoptosis_plot.png")

mm909_h_apoptosis_plot <- plot_geneset(c("HALLMARK_APOPTOSIS"), response_df, fora_results_h_lof_list, mm909_h_apoptosis_plot_path, "FORA with HALLMARK_APOPTOSIS across samples (LoF mutations)", "HALLMARK_APOPTOSIS Gene Set")

print(mm909_h_apoptosis_plot)
```

## Fourth analysis using C6 (oncogenic)

```{r, message=FALSE, warning=FALSE}
# Define paths
fora_results_all_csv_path <- file.path(results_gor_path, "fora_results_c6_all.csv")
fora_results_nosnyn_csv_path <- file.path(results_gor_path, "fora_results_c6_nonsyn.csv")
fora_results_lof_csv_path <- file.path(results_gor_path, "fora_results_c6_lof.csv")

# Perform FORA analysis for H Gene Sets
results_list <- perform_fora_analysis("C6", NULL, list_of_all_mutations, list_of_nonsyn_mutations, list_of_lof_mutations, fora_results_all_csv_path, fora_results_nosnyn_csv_path, fora_results_lof_csv_path)

# Unpack the results_list
fora_results_c6_all_list <- results_list$fora_results_all_list
fora_results_c6_nonsyn_list <- results_list$fora_results_nonsyn_list
fora_results_c6_lof_list <- results_list$fora_results_lof_list
```

### Visualization: Top C5 BP across samples stratified by response (All mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c6_all_plot_path <- file.path(figures_path,
                              "mm909_c6_all_plot.png")

mm909_c6_all_plot <- plot_top5(response_df, fora_results_c6_all_list, mm909_c6_all_plot_path, "FORA with top C5 BP across samples (All mutations)", "Top C5 BP Gene Sets")

print(mm909_c6_all_plot)
```

### Visualization: Top C5 BP across samples stratified by response (Nonsyn mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c6_nonsyn_plot_path <- file.path(figures_path,
                              "mm909_c6_nonsyn_plot.png")

mm909_c6_nonsyn_plot <- plot_top5(response_df, fora_results_c6_nonsyn_list, mm909_c6_nonsyn_plot_path, "FORA with top C5 BP across samples (Nonsyn mutations)", "Top C5 BP Gene Sets")

print(mm909_c6_nonsyn_plot)
```

### Visualization: Top C5 BP across samples stratified by response (LoF mutations)

```{r, message=FALSE, warning=FALSE}
# Define output path
mm909_c6_lof_plot_path <- file.path(figures_path,
                              "mm909_c6_lof_plot.png")

mm909_c6_lof_plot <- plot_top5(response_df, fora_results_c6_lof_list, mm909_c6_lof_plot_path, "FORA with top C6 across samples (LoF mutations)", "Top C6 Gene Sets")

print(mm909_c6_lof_plot)
```

# Session Info

```{r}
sessionInfo()
```
