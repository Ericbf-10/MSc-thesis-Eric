---
title: "Impact of dysfunctional ubiquitination in response to cancer immunotherapy"
subtitle: <center> Somatic mutations analysis - PFAM Analysis </center>
author: "Eric Bautista Farrerons (s212514)"
date: '`r paste("First created on May 2024. Updated on ", format(Sys.Date(), "%d %B %Y"))`'
output:
  html_document:
    css: style.css
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 4
    number_sections: true
---

# Data pre-processing

This document is to analyse the PFAM of the ubiquitin-related genes that have any LoF mutation among all samples and see if there is a pattern that distinguishes responders from non-responders.

```{r, message=FALSE}
### Load required libraries
library(readxl)
library(tidyverse)
library(purrr)
library(dplyr)
library(knitr)
library(DT)
library(jsonlite)

### Load functions
source(file = "../02_functions.R")

### Define paths
current_dir <- getwd()
data_path <- file.path(current_dir,
                       "../../data/_raw")
results_pc_path <- file.path(current_dir,
                              "../../results/patient_characteristics/output")
results_fip_path <- file.path(current_dir,
                              "../../results/somatic_mutation_analysis/functional_impact_prediction/output")
results_ubgenesets_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/ubiquitin_custom_GS/output")
results_ubfora_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/ubiquitin_fora/output")
results_protein_seqs_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/protein_seqs/output")
results_cellular_loc_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/cellular_loc/output")
results_pfam_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/pfam_analysis/output")

# Create the folder if it does not exist
if(!file.exists(results_pfam_path)) {
  dir.create(results_pfam_path, recursive = TRUE)
}

figures_pfam_path <- file.path(current_dir, 
                                 "../../results/somatic_mutation_analysis/pfam_analysis/figures")

# Create the folder if it does not exist
if(!file.exists(figures_pfam_path)) {
  dir.create(figures_pfam_path, recursive = TRUE)
}

### Read data & wrangle
# Sample info
patients_ub_prot_lof_mut_path <- file.path(results_protein_seqs_path, 
                      "prot_lof_patients_ub_mutations.csv")
patients_ub_prot_lof_mut_df <- read.csv(patients_ub_prot_lof_mut_path, header = TRUE)[ , -1]

# Extract only Ensembl Gene and Prot IDs
gene2prot_df <- patients_ub_prot_lof_mut_df %>% 
  dplyr::select(ensembl_id, p_ensembl_id)

# Source info
unique_shared_genes_path <- file.path(results_ubfora_path, 
                      "unique_and_shared_genes_RvsNR.csv")
unique_shared_genes_df <- read.csv(unique_shared_genes_path, header = TRUE)[ , -1]

# Wrangle
gene2source_df <- unique_shared_genes_df %>% 
  dplyr::select(-go_parent_term) %>% 
  dplyr::distinct()

# PFAM info
# JSON
file_paths <- c(
  file.path(data_path, "../pfam_output_01.json"),
  file.path(data_path, "../pfam_output_02.json"),
  file.path(data_path, "../pfam_output_03.json"),
  file.path(data_path, "../pfam_output_04.json")
)

# Use lapply to process each file and combine the results
# all_data <- lapply(file_paths, extract_family_info)

# # Combine all data frames into one
# pfam_df <- bind_rows(all_data)
# rownames(pfam_df) <- NULL

# Save to file
all_pfam_path <- file.path(results_pfam_path, 
                      "all_pfam_data.rds")
# saveRDS(pfam_df, file = all_pfam_path)

pfam_df <- readRDS(all_pfam_path)

# filtered_family_pfam_df <- pfam_df %>% 
#   dplyr::group_by(Protein_accession) %>% 
#   dplyr::filter(signature.entry.type == "FAMILY")

# Filter by DB and domain
filtered_domain_pfam_df <- pfam_df %>% 
  dplyr::group_by(Protein_accession) %>% 
  dplyr::filter(signature.signatureLibraryRelease.library == "PFAM", 
                signature.entry.type == "DOMAIN")

# filtered_family_pfam_df <- pfam_df %>% 
#   dplyr::group_by(Protein_accession) %>% 
#   dplyr::filter(signature.entry.type == "FAMILY")

# Rename and select cols of interest
short_domain_pfam_df <- filtered_domain_pfam_df %>% 
  dplyr::rename(p_ensembl_id = Protein_accession,
                dom_name = signature.entry.name,
                dom_desc = signature.entry.description) %>% 
  dplyr::select(p_ensembl_id, dom_name, dom_desc)

# Standardize domain names
standard_dom_pfam_df <- short_domain_pfam_df %>% 
  mutate(dom_name = case_when(
    str_detect(dom_name, "E1") | str_detect(dom_desc, "E1") ~ "Ub-activating_E1",
    str_detect(dom_name, "E2") | str_detect(dom_desc, "E2") ~ "Ub-conjugting_E2",
    str_detect(dom_name, "E3") | str_detect(dom_desc, "E3") | str_detect(dom_name, "HECT_dom") | str_detect(dom_name, "RING") ~ "Ub-prot_ligase_E3",
    str_detect(dom_name, "C19") | str_detect(dom_desc, "C19") ~ "Peptidase_C19",
    str_detect(dom_name, "Znf") | str_detect(dom_name, "ZF") ~ "Zinc_finger",
    TRUE ~ dom_name  # Keeps the original value if no condition is met
  ))

# filtered_group2_pfam_df <- standard_dom_pfam_df %>%
#   dplyr::group_by(dom_name) %>%
#   dplyr::count() %>%
#   dplyr::arrange(desc(n))

# Merge to genes and source
gene2pfam_df <- standard_dom_pfam_df %>% 
  dplyr::left_join(gene2prot_df, by = "p_ensembl_id")

combined_df <- gene2pfam_df %>% 
  dplyr::left_join(gene2source_df, by = "ensembl_id") %>% 
  dplyr::select(corrected_hugo_symbol, dom_name, source) %>% 
  dplyr::distinct()

combined_df <- combined_df[, !names(combined_df) %in% "p_ensembl_id"]
```

I grouped some PFAM predicted domains manually because they had slightly different names but performed the same function.

# Clustering based on PFAM: Heat map

## R, NR and shared Heat map

```{r, message=FALSE, warning=FALSE, fig.width=20, fig.height=20}
plot_path <- file.path(figures_pfam_path, "pfam_tile_R_NR_shared.png")
tile_plot_pfam(combined_df, plot_path, "Tile plot of PFAM classification of ub genes", 15, 15)
```

```{r, message=FALSE, warning=FALSE, fig.width=20, fig.height=20}
plot_path <- file.path(figures_pfam_path, "pfam_clustering_R_NR_shared.png")
clustering_pfam(combined_df, plot_path, "Clustering of PFAM classification of ub genes", 15, 15)
```

# Session Info

```{r}
sessionInfo()
```
