---
title: "Impact of dysfunctional ubiquitination in response to cancer immunotherapy"
subtitle: <center> Organizing patients characteristics </center>
author: "Eric Bautista Farrerons (s212514)"
date: '`r paste("First created on January 2024. Updated on ", format(Sys.Date(), "%d %B %Y"))`'
output:
  html_document:
    css: style.css
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 4
    number_sections: true
---

```{r, message=FALSE}
### Load required libraries
library(readxl)
library(tidyverse)
library(dplyr)
library(knitr)
library(DT)

### Load functions
source(file = "../02_functions.R")

### Define paths
current_dir <- getwd()

# Sup1
sup1_data <- "../../data/_raw/41467_2017_1460_MOESM4_ESM_clinical.xlsx"
sup1_path <- file.path(current_dir,
                       sup1_data)

# RData obj
mm909_data <- "../../data/_raw/MM909_data.RData"
mm909_path <- file.path(current_dir,
                        mm909_data)

# Provean
provean_path <- "data/provean_output/provean_output"

# MAF-like file
maf_data <- "../../data/_raw/41467_2017_1460_MOESM6_ESM_somatic_mutations.xlsx"
maf_path <- file.path(current_dir,
                      maf_data)

### Read data
sup1_table <- read_excel(sup1_path,
                         skip = 1,
                         col_names = TRUE)
colnames(sup1_table)[1] <- "Sample.ID"

load(mm909_path)

maf_table <- read_excel(maf_path,
                        skip = 1,
                        col_names = TRUE)

### Clean data
# Subset sup1_table
sup1_subset <- sup1_table %>%
  dplyr::select(Sample.ID,
                Sample.Timepoint,
                AJCC.Stage,
                PFS.Time,
                PFS.Event,
                OS.Time,
                OS.Event,
                Type.of.Lesion,
                Type.of.Primary,
                RECIST)

sup1_response <- sup1_subset %>%
  mutate(Patient.Response = case_when(
    RECIST %in% c("CR", "PR") ~ "R",
    RECIST %in% c("SD") & OS.Time >= 24 ~ "R",
    RECIST %in% c("SD") & OS.Time < 24 ~ "NR",
    RECIST %in% c("PD") ~ "NR",
    TRUE ~ NA_character_  # For any cases that don't match above conditions
  )
  )

sup1_final <- sup1_response %>%
  left_join(response %>%
      dplyr::select(patient, mut_load),
    by = c("Sample.ID" = "patient")
  )

# Save the sup1_final into a file
sup1_out_path <- file.path(current_dir,
                           "../../data/sup1_response.csv")
write.csv(sup1_final, file = sup1_out_path, row.names = TRUE)
```

## Patients' characteristics with response to treatment

```{r}
datatable(sup1_final, 
          extensions = c('Buttons', 
                         'FixedColumns'), 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=10,
            fixedColumns = list(leftColumns = 2), # Freeze the first 2 columns
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Patients' characteristics with response to treatment & mut_load"
        )
```

## Group by response

```{r}
response_df <- sup1_final %>% 
  dplyr::count(Patient.Response)

datatable(response_df, 
          extensions = 'Buttons', 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=10,
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Patients' grouped by response"
        )
```

## Extract patients' IDs removed from RData object

```{r}
### Extract rows with NAs in mut_load
rows_with_na <- sup1_final[is.na(sup1_final$mut_load), ]
datatable(rows_with_na, 
          extensions = c('Buttons', 
                         'FixedColumns'), 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=5,
            fixedColumns = list(leftColumns = 2), # Freeze the first 2 columns
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Patients' removed from RData object."
        )
```

## Create a list of patients' IDs present in MAF file

```{r}
### Sort IDs from maf_table
sorted_ids <- maf_table %>%
  dplyr::select(tumor_name) %>%
  distinct(tumor_name) %>%
  arrange(tumor_name)

# Display the result
datatable(sorted_ids, 
          extensions = 'Buttons', 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=24,
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Sorted IDs from maf_table"
        )
```

## Check if patients' IDs excluded in RData are present in MAF file

```{r}
search_ids <- c("MM909_01", "MM909_20", "MM909_24", "MM909_29", "MM909_45")

# Check if each ID is in the unique_sorted_ids dataframe
is_id_present <- sapply(search_ids, 
                        function(id) any(str_detect(sorted_ids$tumor_name, id)))

# Combine the IDs and their presence status into a data frame for easy viewing
patients_present <- data.frame(Sample.ID = search_ids, Is.Present = is_id_present)

# Display the results
datatable(patients_present, 
          extensions = 'Buttons', 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=24,
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Patient IDs excluded in RData present/absent in MAF file"
        )
```

## Conclusions

1. There are 3 patients that are absent in the RData and also in the MAF-like file:

  - MM909_01
  - MM909_29
  - MM909_45

  This is because their samples failed the WES. It is described in the paper.

2. There are 2 patients that are absent in the RData but present in the MAF-like file:

  - MM909_20
  - MM909_24

  This is because they don't have RNA-Seq data. It is described in the paper.
  
## Results table

```{r}
# Merge the 2 dataframes on "Sample.ID"
tmp_merge <- left_join(sup1_final, patients_present, by = "Sample.ID")

results_df <- tmp_merge %>%
  mutate(RNASeq.Data = case_when(
    Is.Present == TRUE ~ "NO",
    Is.Present == FALSE | is.na(Is.Present) ~ "YES")
    ) %>% 
  mutate(WES.Data = case_when(
    Is.Present == TRUE | is.na(Is.Present) ~ "YES",
    Is.Present == FALSE ~ "FAILED")
    ) %>% 
  dplyr::select(Sample.ID,
                Type.of.Primary,
                RNASeq.Data,
                WES.Data)

# Display the results
datatable(results_df, 
          extensions = 'Buttons', 
          options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'excel', 'csv'),
            scrollX=TRUE,
            pageLength=10,
            columnDefs = list(list(
              targets = "_all",
              render = JS(
                "function(data, type, row, meta) {",
                "  return data === null ? 'NA' : data;",
                "}"
              )
            ))
          ),
          caption = "Present/missing data per patient"
        )
```
  
## Session Info
  
```{r}
sessionInfo()
```